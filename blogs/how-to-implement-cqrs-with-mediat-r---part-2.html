<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width, shrink-to-fit=no, user-scalable=no, viewport-fit=cover"/><title>How to implement CQRS with MediatR - Part 2</title><meta name="title" content="How to implement CQRS with MediatR - Part 2"/><meta name="description" content="This post is about implementing mediator pattern in a dotnet WebAPI using MediatR library."/><meta name="og:type" content="article"/><meta name="og:url" content="/blog/how-to-implement-cqrs-with-mediat-r---part-2"/><meta name="og:title" content="How to implement CQRS with MediatR - Part 2"/><meta name="og:description" content="This post is about implementing mediator pattern in a dotnet WebAPI using MediatR library."/><meta name="og:image" content="banners/17.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:url" content="/blog/how-to-implement-cqrs-with-mediat-r---part-2"/><meta name="twitter:title" content="How to implement CQRS with MediatR - Part 2"/><meta name="twitter:description" content="This post is about implementing mediator pattern in a dotnet WebAPI using MediatR library."/><meta name="twitter:image" content="banners/17.png"/><meta name="twitter:site" content="@krishnaanaril"/><meta name="twitter:creator" content="@krishnaanaril"/><meta name="keywords" content="dotnet, mediatr, CancellationToken"/><meta name="og:article:published_time" content="2021-02-27T00:00:00.000Z"/><meta name="og:article:modified_time" content="2021-02-27T00:00:00.000Z"/><meta name="og:article:author" content="Krishna Mohan A M"/><meta name="og:article:section" content="tech"/><meta name="og:article:tag" content="dotnet, mediatr, CancellationToken"/><meta name="next-head-count" content="23"/><link href="https://unpkg.com/prism-themes@1.6.0/themes/prism-shades-of-purple.css" rel="stylesheet"/><link rel="preload" href="/_next/static/css/4a2588553a45f461.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4a2588553a45f461.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-2b80368ae5a19708.js" defer=""></script><script src="/_next/static/chunks/pages/_app-964bc742f6b6115c.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5Bid%5D-ee2f0cd279d3564a.js" defer=""></script><script src="/_next/static/cQOLbeBqmzJqpuglyRpu7/_buildManifest.js" defer=""></script><script src="/_next/static/cQOLbeBqmzJqpuglyRpu7/_ssgManifest.js" defer=""></script></head><body class="bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50 px-5 lg:px-0"><div id="__next"><div><nav class="sticky top-0 text-gray-800 dark:text-gray-50 backdrop-blur-lg mix-blend-multiply dark:mix-blend-color-dodge"><section class="hidden lg:flex flex-row justify-center"><nav><ul class="lg:text-xl lg:flex lg:flex-row"><li class="p-3 cursor-pointer"><a href="/">Home</a></li><li class="p-3 cursor-pointer border-b-2 border-gray-700 dark:border-gray-300"><a href="/blogs">Blog</a></li><li class="p-3 cursor-pointer"><a href="/projects">Projects</a></li><li class="p-3 cursor-pointer"><a href="/about">About</a></li></ul></nav></section><div class="absolute lg:hidden mr-4 p-4 right-0"><button class="p-2" aria-label="view menu items"><svg class="fill-gray-800 dark:fill-gray-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="24px" height="24px"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></nav><div class="min-h-screen"><article class="bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><div><div aria-label="Blog tags/keywords" class="pt-8 flex flex-row justify-center"><div class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full">dotnet</div><div class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full">mediatr</div><div class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full">CancellationToken</div></div><div class="max-w-screen-lg mx-auto"><h1 class="text-5xl pt-5 pb-5 text-center">How to implement CQRS with MediatR - Part 2</h1></div><div class="flex flex-row justify-center m-5 max-w-screen-sm mx-auto"><time class="text-center text-xl">27 February 2021</time></div></div><div class="prose dark:prose-invert lg:prose-xl md:prose-lg max-w-screen-md mx-auto"><p>In this post we'll be using MediatR with a dotnet WebAPI. If you want to read about its implementation in a console application, check out my other blog <a href="https://krishnamohan.dev/blog/how-to-implement-cqrs-with-mediat-r---part-1">post</a>.</p>
<p>For basic cases you can implement the message types and handlers mentioned in the Part 1. Here we are trying a different use case. The use of <code>CancellationToken</code> in <code>MediatR</code> to drop the ongoing request processing. This is very helpful if the request processing is blocked and we want to implement a timeout or if the request is dropped by the initiator.</p>
<p>For the sample case we will create a web api that try to do a task within 5 seconds. The API method will accept time in milliseconds and if the given time is greater than 5 seconds the task will run for 5 seconds and then get cancelled, otherwise task will be executed for the given time.</p>
<h2>Prerequisites</h2>
<ul>
<li>Install <a href="https://dotnet.microsoft.com/download">dotnet core</a></li>
<li>Install Visual Studio Code/Visual Studio IDE</li>
</ul>
<h2>Creating a dotnet WebAPI application</h2>
<p>Run the following CLI command to create a WebAPI project.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">dotnet new webapi MediatRSampleAPI
</code></pre></div>
<h2>Configure Serilog for logging (Optional)</h2>
<p>I'll be using <a href="https://serilog.net/">Serilog</a> and a flat file sink for logging. To configure this we need to install the following dependencies via Nuget.</p>
<ul>
<li>Microsoft.Extensions.Logging</li>
<li>Serilog</li>
<li>Serilog.AspNetCore</li>
<li>Serilog.Sinks.File</li>
</ul>
<p>Then update the <code>Program.cs</code> file.</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>Enrich<span class="token punctuation">.</span><span class="token function">FromLogContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">File</span><span class="token punctuation">(</span><span class="token string">"logs/MediatRSample.txt"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">rollingInterval</span><span class="token punctuation">:</span> RollingInterval<span class="token punctuation">.</span>Day<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token string">"Starting up"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Application start-up failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">CloseAndFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IHostBuilder</span> <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span> <span class="token operator">=></span>
    Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">UseSerilog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=></span>
        <span class="token punctuation">{</span>
            webBuilder<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">UseStartup</span><span class="token generic class-name"><span class="token punctuation">&#x3C;</span>Startup<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<h2>Install and Configure MediatR</h2>
<p>Next we need to install MediatR (version 9.0.0 at the time of writing) via Nuget. To configure MediatR, add the following snippet to the <code>ConfigureServices()</code> method in <code>Startup.cs</code> file.</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddMediatR</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Startup</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<h2>Create a Notification message and its handler</h2>
<p>Our notification message carries time in milliseconds. Handler just accepts the time given by the user and waits for that much time. In the meantime if the request is cancelled, waiting will be stopped and exit.</p>
<p>I've added <code>Stopwatch</code> code to make sure that handler will wait for maximum 5 seconds. When cancellation is triggered and <code>OperationCanceledException</code> is thrown we need to catch it explicitly.</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayNotificationMessage</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">INotification</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> TimeInMilliSeconds <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Notifier03</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">INotificationHandler<span class="token punctuation">&#x3C;</span>DelayNotificationMessage<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&#x3C;</span>Notifier03<span class="token punctuation">></span></span> _logger<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">Notifier03</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&#x3C;</span>Notifier03<span class="token punctuation">></span></span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">DelayNotificationMessage</span> notification<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Notifier 03 -> Time In MIlli Seconds: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">notification<span class="token punctuation">.</span>TimeInMilliSeconds</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> Stopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>TimeInMilliSeconds<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">OperationCanceledException</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"5 seconds passed and the task is cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>                
        <span class="token punctuation">}</span>
        stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Elapsed Time: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">stopwatch<span class="token punctuation">.</span>ElapsedMilliseconds</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2>Create a mediator service</h2>
<p>Mediator Service is a class that is used by the initiator to publish messages to the handlers. Here we'll the add the following code in the service class where <code>CancellationToken</code> is an optional parameter.</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DelayedNotify</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> timeInMilliSeconds<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _mediator<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">DelayNotificationMessage</span> <span class="token punctuation">{</span> TimeInMilliSeconds <span class="token operator">=</span> timeInMilliSeconds <span class="token punctuation">}</span><span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
</code></pre></div>
<h2>Add new method in API Controller</h2>
<p>Now let's add a controller method that creates a cancellation token. CancellationToken is set to cancel after 5 seconds using the <code>CancelAfter</code> <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtokensource?view=net-5.0#methods">method</a> of <code>CancellationTokenSource</code></p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"/dowithin5seconds"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&#x3C;</span><span class="token keyword">string</span><span class="token punctuation">></span></span> <span class="token function">DoWithin5Seconds</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> timeInMilliSeconds<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">CancellationTokenSource</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CancellationToken</span> token <span class="token operator">=</span> source<span class="token punctuation">.</span>Token<span class="token punctuation">;</span>
    source<span class="token punctuation">.</span><span class="token function">CancelAfter</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mediatorService<span class="token punctuation">.</span><span class="token function">DelayedNotify</span><span class="token punctuation">(</span>timeInMilliSeconds<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> message <span class="token operator">=</span> <span class="token string">"Finished within 5 seconds."</span><span class="token punctuation">;</span>

    _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> message<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2>Run the application</h2>
<p>To run the project via dotnet cli, run the following command.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash">dotnet run <span class="token parameter variable">--project</span> <span class="token operator">&#x3C;</span>Path to *.csproj file<span class="token operator">></span>
</code></pre></div>
<p>Once the port is open, invoke the <code>DoWithin5Seconds</code> method by entering 'http://localhost:62705/dowithin5seconds?timeInMilliSeconds=15000' in the browser (Your port number may vary. Also for the demo purpose it is better to disable https redirection).</p>
<p>You'll get the response immediately, but the process will run for a maximum of 5 seconds. If you check the log file, you can see that the execution stopped at 5 seconds.</p>
<div class="remark-highlight"><pre class="language-bash"><code class="language-bash"><span class="token number">2021</span>-02-27 <span class="token number">12</span>:46:57.384 +05:30 <span class="token punctuation">[</span>INF<span class="token punctuation">]</span> Executing endpoint <span class="token string">'MediatRSampleAPI.Controllers.SlowTestController.DoWithin5Seconds (MediatRSampleAPI)'</span>
<span class="token number">2021</span>-02-27 <span class="token number">12</span>:46:57.425 +05:30 <span class="token punctuation">[</span>INF<span class="token punctuation">]</span> Route matched with <span class="token punctuation">{</span>action <span class="token operator">=</span> <span class="token string">"DoWithin5Seconds"</span>, controller <span class="token operator">=</span> <span class="token string">"SlowTest"</span><span class="token punctuation">}</span>. Executing controller action with signature System.Threading.Tasks.Task`1<span class="token punctuation">[</span>System.String<span class="token punctuation">]</span> DoWithin5Seconds<span class="token punctuation">(</span>Int32<span class="token punctuation">)</span> on controller MediatRSampleAPI.Controllers.SlowTestController <span class="token punctuation">(</span>MediatRSampleAPI<span class="token punctuation">)</span>.
<span class="token number">2021</span>-02-27 <span class="token number">12</span>:46:57.517 +05:30 <span class="token punctuation">[</span>INF<span class="token punctuation">]</span> Executing action method MediatRSampleAPI.Controllers.SlowTestController.DoWithin5Seconds <span class="token punctuation">(</span>MediatRSampleAPI<span class="token punctuation">)</span> - Validation state: <span class="token string">"Valid"</span>
<span class="token number">2021</span>-02-27 <span class="token number">12</span>:46:57.524 +05:30 <span class="token punctuation">[</span>INF<span class="token punctuation">]</span> Notifier 03 -<span class="token operator">></span> Time In MIlli Seconds: <span class="token number">15000</span>
<span class="token number">2021</span>-02-27 <span class="token number">12</span>:46:57.526 +05:30 <span class="token punctuation">[</span>INF<span class="token punctuation">]</span> Finished within <span class="token number">5</span> seconds.
<span class="token number">2021</span>-02-27 <span class="token number">12</span>:47:02.576 +05:30 <span class="token punctuation">[</span>ERR<span class="token punctuation">]</span> <span class="token number">5</span> seconds passed and the task is cancelled
<span class="token number">2021</span>-02-27 <span class="token number">12</span>:47:02.577 +05:30 <span class="token punctuation">[</span>INF<span class="token punctuation">]</span> Elapsed Time: <span class="token number">5052</span>
</code></pre></div>
<p>Full source code is available in <a href="https://github.com/krishnaanaril/try-outs/tree/master/MediatRSample/MediatRSampleAPI">GitHub</a>.</p>
<h2>Final Thoughts</h2>
<p>If you are more interested in the use of <code>CancellationToken</code>, please checkout the <a href="https://andrewlock.net/using-cancellationtokens-in-asp-net-core-mvc-controllers/">post</a> by Andrew Lock.</p>
<p>One thing I haven't explored so far is exception handling with MediatR. It requires a blog post of its own and I'll be posting it soon.</p>
</div></article></div><footer class="flex flex-col bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><div class="mt-10"><ul class="flex flex-row justify-between max-w-sm mx-auto pl-4 pr-4"><li class="hover:text-gray-600 dark:hover:text-gray-100"><a href="https://twitter.com/KrishnaAnaril">Twitter</a></li><li><a href="https://krishnamohan.dev/sitemap.xml">Sitemap</a></li><li><a href="https://krishnamohan.dev/feed.xml">RSS</a></li><li><a href="mailto:krishnamohan.a.m@gmail.com">Contact</a></li></ul></div><div class="mx-auto p-5 text-sm"><p>© 2021-present <a class="font-bold" href="https://krishnamohan.dev/">Krishna Mohan A M</a>. All Rights Reserved.</p></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"how-to-implement-cqrs-with-mediat-r---part-2","meta":{"title":"How to implement CQRS with MediatR - Part 2","description":"This post is about implementing mediator pattern in a dotnet WebAPI using MediatR library.","published":true,"publishedAt":"2021-02-27T00:00:00.000Z","updatedAt":"2021-02-27T00:00:00.000Z","category":"tech","image":"banners/17","keywords":["dotnet","mediatr","CancellationToken"],"authors":["Krishna Mohan A M"]},"content":"\u003cp\u003eIn this post we'll be using MediatR with a dotnet WebAPI. If you want to read about its implementation in a console application, check out my other blog \u003ca href=\"https://krishnamohan.dev/blog/how-to-implement-cqrs-with-mediat-r---part-1\"\u003epost\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eFor basic cases you can implement the message types and handlers mentioned in the Part 1. Here we are trying a different use case. The use of \u003ccode\u003eCancellationToken\u003c/code\u003e in \u003ccode\u003eMediatR\u003c/code\u003e to drop the ongoing request processing. This is very helpful if the request processing is blocked and we want to implement a timeout or if the request is dropped by the initiator.\u003c/p\u003e\n\u003cp\u003eFor the sample case we will create a web api that try to do a task within 5 seconds. The API method will accept time in milliseconds and if the given time is greater than 5 seconds the task will run for 5 seconds and then get cancelled, otherwise task will be executed for the given time.\u003c/p\u003e\n\u003ch2\u003ePrerequisites\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eInstall \u003ca href=\"https://dotnet.microsoft.com/download\"\u003edotnet core\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eInstall Visual Studio Code/Visual Studio IDE\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eCreating a dotnet WebAPI application\u003c/h2\u003e\n\u003cp\u003eRun the following CLI command to create a WebAPI project.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003edotnet new webapi MediatRSampleAPI\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eConfigure Serilog for logging (Optional)\u003c/h2\u003e\n\u003cp\u003eI'll be using \u003ca href=\"https://serilog.net/\"\u003eSerilog\u003c/a\u003e and a flat file sink for logging. To configure this we need to install the following dependencies via Nuget.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMicrosoft.Extensions.Logging\u003c/li\u003e\n\u003cli\u003eSerilog\u003c/li\u003e\n\u003cli\u003eSerilog.AspNetCore\u003c/li\u003e\n\u003cli\u003eSerilog.Sinks.File\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThen update the \u003ccode\u003eProgram.cs\u003c/code\u003e file.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eMain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e args\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    Log\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLogger \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003eLoggerConfiguration\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eEnrich\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFromLogContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eWriteTo\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"logs/MediatRSample.txt\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token named-parameter punctuation\"\u003erollingInterval\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e RollingInterval\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eDay\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eCreateLogger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        Log\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eInformation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Starting up\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eCreateHostBuilder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eBuild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eRun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        Log\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFatal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eex\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Application start-up failed\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efinally\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        Log\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eCloseAndFlush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003eIHostBuilder\u003c/span\u003e \u003cspan class=\"token function\"\u003eCreateHostBuilder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e args\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e\n    Host\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eCreateDefaultBuilder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eargs\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eUseSerilog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eConfigureWebHostDefaults\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewebBuilder \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            webBuilder\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token generic-method\"\u003e\u003cspan class=\"token function\"\u003eUseStartup\u003c/span\u003e\u003cspan class=\"token generic class-name\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eStartup\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eInstall and Configure MediatR\u003c/h2\u003e\n\u003cp\u003eNext we need to install MediatR (version 9.0.0 at the time of writing) via Nuget. To configure MediatR, add the following snippet to the \u003ccode\u003eConfigureServices()\u003c/code\u003e method in \u003ccode\u003eStartup.cs\u003c/code\u003e file.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003eservices\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eAddMediatR\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etypeof\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token type-expression class-name\"\u003eStartup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eCreate a Notification message and its handler\u003c/h2\u003e\n\u003cp\u003eOur notification message carries time in milliseconds. Handler just accepts the time given by the user and waits for that much time. In the meantime if the request is cancelled, waiting will be stopped and exit.\u003c/p\u003e\n\u003cp\u003eI've added \u003ccode\u003eStopwatch\u003c/code\u003e code to make sure that handler will wait for maximum 5 seconds. When cancellation is triggered and \u003ccode\u003eOperationCanceledException\u003c/code\u003e is thrown we need to catch it explicitly.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDelayNotificationMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token type-list\"\u003e\u003cspan class=\"token class-name\"\u003eINotification\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003c/span\u003e TimeInMilliSeconds \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eNotifier03\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token type-list\"\u003e\u003cspan class=\"token class-name\"\u003eINotificationHandler\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eDelayNotificationMessage\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereadonly\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eILogger\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eNotifier03\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e _logger\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token function\"\u003eNotifier03\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eILogger\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eNotifier03\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e logger\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        _logger \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e logger\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003eTask\u003c/span\u003e \u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eDelayNotificationMessage\u003c/span\u003e notification\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCancellationToken\u003c/span\u003e cancellationToken\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        _logger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eLogInformation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token interpolation-string\"\u003e\u003cspan class=\"token string\"\u003e$\"Notifier 03 -\u003e Time In MIlli Seconds: \u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token expression language-csharp\"\u003enotification\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eTimeInMilliSeconds\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token class-name\"\u003eStopwatch\u003c/span\u003e stopwatch \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Stopwatch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eStartNew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003etry\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e Task\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDelay\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enotification\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eTimeInMilliSeconds\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cancellationToken\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eOperationCanceledException\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            _logger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eLogError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"5 seconds passed and the task is cancelled\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ecatch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eException\u003c/span\u003e ex\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            _logger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eLogError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eex\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMessage\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e                \n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        stopwatch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eStop\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        _logger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eLogInformation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token interpolation-string\"\u003e\u003cspan class=\"token string\"\u003e$\"Elapsed Time: \u003c/span\u003e\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token expression language-csharp\"\u003estopwatch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eElapsedMilliseconds\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e            \n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eCreate a mediator service\u003c/h2\u003e\n\u003cp\u003eMediator Service is a class that is used by the initiator to publish messages to the handlers. Here we'll the add the following code in the service class where \u003ccode\u003eCancellationToken\u003c/code\u003e is an optional parameter.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eDelayedNotify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003c/span\u003e timeInMilliSeconds\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eCancellationToken\u003c/span\u003e cancellationToken \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edefault\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    _mediator\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePublish\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003eDelayNotificationMessage\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e TimeInMilliSeconds \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e timeInMilliSeconds \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cancellationToken\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eAdd new method in API Controller\u003c/h2\u003e\n\u003cp\u003eNow let's add a controller method that creates a cancellation token. CancellationToken is set to cancel after 5 seconds using the \u003ccode\u003eCancelAfter\u003c/code\u003e \u003ca href=\"https://docs.microsoft.com/en-us/dotnet/api/system.threading.cancellationtokensource?view=net-5.0#methods\"\u003emethod\u003c/a\u003e of \u003ccode\u003eCancellationTokenSource\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token attribute\"\u003e\u003cspan class=\"token class-name\"\u003eHttpGet\u003c/span\u003e\u003cspan class=\"token attribute-arguments\"\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/dowithin5seconds\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"token return-type class-name\"\u003eTask\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token function\"\u003eDoWithin5Seconds\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003c/span\u003e timeInMilliSeconds\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eCancellationTokenSource\u003c/span\u003e source \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003eCancellationTokenSource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003eCancellationToken\u003c/span\u003e token \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e source\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eToken\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    source\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eCancelAfter\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e5000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    _mediatorService\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDelayedNotify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etimeInMilliSeconds\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e token\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e\u003c/span\u003e message \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Finished within 5 seconds.\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    _logger\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eLogInformation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emessage\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e message\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eRun the application\u003c/h2\u003e\n\u003cp\u003eTo run the project via dotnet cli, run the following command.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003edotnet run \u003cspan class=\"token parameter variable\"\u003e--project\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003ePath to *.csproj file\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOnce the port is open, invoke the \u003ccode\u003eDoWithin5Seconds\u003c/code\u003e method by entering 'http://localhost:62705/dowithin5seconds?timeInMilliSeconds=15000' in the browser (Your port number may vary. Also for the demo purpose it is better to disable https redirection).\u003c/p\u003e\n\u003cp\u003eYou'll get the response immediately, but the process will run for a maximum of 5 seconds. If you check the log file, you can see that the execution stopped at 5 seconds.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e-02-27 \u003cspan class=\"token number\"\u003e12\u003c/span\u003e:46:57.384 +05:30 \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eINF\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e Executing endpoint \u003cspan class=\"token string\"\u003e'MediatRSampleAPI.Controllers.SlowTestController.DoWithin5Seconds (MediatRSampleAPI)'\u003c/span\u003e\n\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e-02-27 \u003cspan class=\"token number\"\u003e12\u003c/span\u003e:46:57.425 +05:30 \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eINF\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e Route matched with \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eaction \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"DoWithin5Seconds\"\u003c/span\u003e, controller \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"SlowTest\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e. Executing controller action with signature System.Threading.Tasks.Task`1\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eSystem.String\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e DoWithin5Seconds\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eInt32\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e on controller MediatRSampleAPI.Controllers.SlowTestController \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eMediatRSampleAPI\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e.\n\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e-02-27 \u003cspan class=\"token number\"\u003e12\u003c/span\u003e:46:57.517 +05:30 \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eINF\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e Executing action method MediatRSampleAPI.Controllers.SlowTestController.DoWithin5Seconds \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eMediatRSampleAPI\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e - Validation state: \u003cspan class=\"token string\"\u003e\"Valid\"\u003c/span\u003e\n\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e-02-27 \u003cspan class=\"token number\"\u003e12\u003c/span\u003e:46:57.524 +05:30 \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eINF\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e Notifier 03 -\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e Time In MIlli Seconds: \u003cspan class=\"token number\"\u003e15000\u003c/span\u003e\n\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e-02-27 \u003cspan class=\"token number\"\u003e12\u003c/span\u003e:46:57.526 +05:30 \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eINF\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e Finished within \u003cspan class=\"token number\"\u003e5\u003c/span\u003e seconds.\n\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e-02-27 \u003cspan class=\"token number\"\u003e12\u003c/span\u003e:47:02.576 +05:30 \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eERR\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e seconds passed and the task is cancelled\n\u003cspan class=\"token number\"\u003e2021\u003c/span\u003e-02-27 \u003cspan class=\"token number\"\u003e12\u003c/span\u003e:47:02.577 +05:30 \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eINF\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e Elapsed Time: \u003cspan class=\"token number\"\u003e5052\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFull source code is available in \u003ca href=\"https://github.com/krishnaanaril/try-outs/tree/master/MediatRSample/MediatRSampleAPI\"\u003eGitHub\u003c/a\u003e.\u003c/p\u003e\n\u003ch2\u003eFinal Thoughts\u003c/h2\u003e\n\u003cp\u003eIf you are more interested in the use of \u003ccode\u003eCancellationToken\u003c/code\u003e, please checkout the \u003ca href=\"https://andrewlock.net/using-cancellationtokens-in-asp-net-core-mvc-controllers/\"\u003epost\u003c/a\u003e by Andrew Lock.\u003c/p\u003e\n\u003cp\u003eOne thing I haven't explored so far is exception handling with MediatR. It requires a blog post of its own and I'll be posting it soon.\u003c/p\u003e\n"},"__N_SSG":true},"page":"/blogs/[id]","query":{"id":"how-to-implement-cqrs-with-mediat-r---part-2"},"buildId":"cQOLbeBqmzJqpuglyRpu7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>