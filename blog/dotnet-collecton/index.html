<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width, shrink-to-fit=no, user-scalable=1, viewport-fit=cover"/><title>Understanding the nuances of C# Collections | Krishna Mohan A M</title><meta name="title" content="Understanding the nuances of C# Collections"/><meta name="description" content="This article is based on .NET 9 and C# 13. I aim to cover the behaviors of common collections within the `System.Collections.Generic` namespace."/><meta name="og:type" content="article"/><meta name="og:url" content="/blog/dotnet-collecton"/><meta name="og:title" content="Understanding the nuances of C# Collections"/><meta name="og:description" content="This article is based on .NET 9 and C# 13. I aim to cover the behaviors of common collections within the `System.Collections.Generic` namespace."/><meta name="og:image" content="https://krishnamohan.dev/banners/76.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:url" content="/blog/dotnet-collecton"/><meta name="twitter:title" content="Understanding the nuances of C# Collections"/><meta name="twitter:description" content="This article is based on .NET 9 and C# 13. I aim to cover the behaviors of common collections within the `System.Collections.Generic` namespace."/><meta name="twitter:image" content="https://krishnamohan.dev/banners/76.png"/><meta name="twitter:site" content="@krishnaanaril"/><meta name="twitter:creator" content="@krishnaanaril"/><meta name="keywords" content="dotnet, performance"/><meta name="og:article:published_time" content="2025-01-05T00:00:00.000Z"/><meta name="og:article:modified_time" content="2025-01-05T00:00:00.000Z"/><meta name="og:article:author" content="Krishna Mohan A M"/><meta name="og:article:section" content="tech"/><meta name="og:article:tag" content="dotnet, performance"/><meta name="next-head-count" content="23"/><link href="https://unpkg.com/prism-themes@1.6.0/themes/prism-shades-of-purple.css" rel="stylesheet"/><link rel="preload" href="/_next/static/css/4c58d0963c75419a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4c58d0963c75419a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-3653f441c4a2aa8a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e1cb0d25eaeaa056.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-911bf6dd096ab7ef.js" defer=""></script><script src="/_next/static/lt5HvSSstjkta2Ri8qfBw/_buildManifest.js" defer=""></script><script src="/_next/static/lt5HvSSstjkta2Ri8qfBw/_ssgManifest.js" defer=""></script></head><body class="bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50 px-5 lg:px-0"><div id="__next"><div><nav class="sticky top-0 bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50 bg-opacity-50 dark:bg-opacity-50 backdrop-blur-lg"><section class="hidden lg:flex flex-row justify-center"><nav><ul class="lg:text-xl lg:flex lg:flex-row"><li class=""><a class="block p-4 cursor-pointer" href="/">Home</a></li><li class="border-b-2 border-gray-700 dark:border-gray-300"><a class="block p-4 cursor-pointer" href="/blogs/">Blog</a></li><li class=""><a class="block p-4 cursor-pointer" href="/projects/">Projects</a></li><li class=""><a class="block p-4 cursor-pointer" href="/about/">About</a></li></ul></nav></section><div class="lg:hidden mr-4 py-4 right-0"><button class="p-2" aria-label="view menu items"><svg class="fill-gray-800 dark:fill-gray-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="24px" height="24px"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></nav><div style="display:none" class="fixed top-0 left-0 bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50 bg-opacity-50 dark:bg-opacity-50 backdrop-blur-lg block h-screen lg:hidden p-2 w-screen z-1"><div class="bg-gray-100 bg-opacity-100 m-5 p-5 rounded-lg shadow-xl dark:bg-gray-600 dark:text-gray-50"><div class="flex flex-row justify-end"><button class="dark:text-gray-50" aria-label="close menu items"><svg class="fill-current" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"></path><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button></div><ul class="list-none"><li class=""><a class="block p-4 cursor-pointer" href="/">Home</a></li><li class="border-b-2 border-gray-700 dark:border-gray-300"><a class="block p-4 cursor-pointer" href="/blogs/">Blog</a></li><li class=""><a class="block p-4 cursor-pointer" href="/projects/">Projects</a></li><li class=""><a class="block p-4 cursor-pointer" href="/about/">About</a></li></ul></div></div><div class="min-h-screen"><article class="bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><div><div aria-label="Blog tags/keywords" class="pt-8 flex flex-row justify-center"><a class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full" href="/blogs/tag/dotnet/">dotnet</a><a class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full" href="/blogs/tag/performance/">performance</a></div><div class="max-w-screen-lg mx-auto"><h1 class="text-5xl font-bold pt-5 pb-5 text-center">Understanding the nuances of C# Collections</h1></div><div class="flex flex-row justify-center m-5 max-w-screen-sm mx-auto"><time class="text-center text-xl">5 January 2025</time></div></div><div class="prose dark:prose-invert lg:prose-xl md:prose-lg max-w-screen-md mx-auto"><p>This article is based on .NET 9 and C# 13. I aim to cover the behaviors of common collections within the <code>System.Collections.Generic</code> namespace.</p>
<h2>Insertion behaviors in Dictionary</h2>
<p>The <code>Dictionary&#x3C;TKey, TValue></code> provides a mapping from a set of keys to a set of values. Values can be inserted into a dictionary with varying behaviors. Insertion in a <code>Dictionary</code> is implemented by the private method <a href="https://github.com/dotnet/runtime/blob/1d1bf92fcf43aa6981804dc53c5174445069c9e4/src/libraries/System.Private.CoreLib/src/System/Collections/Generic/Dictionary.cs#L507"><code>TryInsert</code></a>. This method accepts an additional parameter <code>behavior</code>, which is an enum with values <code>IgnoreInsertion</code>, <code>OverwriteExisting</code>, and <code>ThrowOnExisting</code>. Consider the following code, where each operation behaves differently:</p>
<div class="remark-highlight"><pre class="language-csharp"><code class="language-csharp"><span class="token class-name">Dictionary<span class="token punctuation">&#x3C;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">></span></span> dict <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&#x3C;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dict<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Calls underlying private method TryInsert with behavior OverwriteExisting</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dict<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Calls underlying private method TryInsert with behavior IgnoreInsertion</span>
Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>dict<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dict<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Calls underlying private method TryInsert with behavior ThrowOnExisting</span>
</code></pre></div>
<h2>The Curious case of 'Capacity' and 'Count'</h2>
<p>The <code>Dictionary</code> also exposes two properties: <code>Count</code> and <code>Capacity</code>. <code>Count</code> denotes the number of key-value pairs in the dictionary, and <code>Capacity</code> denotes the size of the underlying container that holds the dictionary. The <code>Capacity</code> property was only exposed from .NET 9 and is not available in older versions of .NET. We can specify the value for <code>Capacity</code> in the constructor: <code>Dictionary&#x3C;int, int> dict = new Dictionary&#x3C;int, int>(5);</code>, which will create an underlying container of size 7. <strong>Why size 7?</strong> Initially, I was puzzled too, so I checked the source code of the Dictionary implementation.</p>
<p>The size is 7 because .NET uses a <a href="https://github.com/dotnet/runtime/blob/main/src/libraries/System.Private.CoreLib/src/System/Collections/HashHelpers.cs#L31">prime array</a>, and the code selects the smallest prime number from the array that is larger than the given capacity. Here is the prime array for reference:</p>
<div class="remark-highlight"><pre class="language-C"><code class="language-C">internal static ReadOnlySpan&#x26;lt;int&#x26;gt; Primes =&#x26;gt;
    [
        3, 7, 11, 17, 23, 29, 37, 47, 59, 71, 89, 107, 131, 163, 197, 239, 293, 353, 431, 521, 631, 761, 919,
        1103, 1327, 1597, 1931, 2333, 2801, 3371, 4049, 4861, 5839, 7013, 8419, 10103, 12143, 14591,
        17519, 21023, 25229, 30293, 36353, 43627, 52361, 62851, 75431, 90523, 108631, 130363, 156437,
        187751, 225307, 270371, 324449, 389357, 467237, 560689, 672827, 807403, 968897, 1162687, 1395263,
        1674319, 2009191, 2411033, 2893249, 3471899, 4166287, 4999559, 5999471, 7199369
    ];</code></pre></div>
<p>Now, with the size being 7, when we insert the 8th item into the <code>Dictionary</code>, .NET needs to resize the underlying container. For resizing, .NET first computes twice the current count and then finds the first prime number from the array that is larger than this value. In this example, it is 7 * 2 = 14, and the next prime in the list is 17. Therefore, after inserting the 8th item, the capacity of the dictionary will be 17.</p>
<p>Also, if you know the size of the data in advance, specifying the capacity can provide a minor performance boost. Please see the benchmark results below for <code>Dictionary</code> insertion.</p>
<p><img src="/images/Benchmark.PNG" alt=""><em>Gist: Benchmark results for Dictionary insert</em></p>
<p><code>HashSet</code> and <code>OrderedDictionary</code> also behave in the same way with respect to capacity and resizing.</p>
<p>For <code>Stack&#x3C;T></code>,<code> Queue&#x3C;T></code>, <code>SortedList&#x3C;TKey, TValue></code>, and <code>List&#x3C;T></code>, resizing is not based on the prime array. In these cases, the container is created with the given capacity in the constructor, and for resizing, the size is simply doubled. Consider the example: <code>Stack&#x3C;int> ints = new Stack&#x3C;int>(5);</code>. After pushing the 6th item, the size is doubled to 10.</p>
<p><code>PriorityQueue&#x3C;TElement, TPriority></code> works similarly to <code>Queue&#x3C;T></code> and <code>List&#x3C;T></code>, but the property Capacity is not yet exposed.</p>
<h2>Final Note</h2>
<p>Understanding the inner workings of collections in C# can greatly enhance your ability to write efficient and effective code. As we've seen, the <code>Dictionary&#x3C;TKey, TValue></code> class in .NET 9 has some interesting behaviors, particularly with how it handles capacity and resizing. By leveraging the prime number array for sizing, .NET ensures that the hash table's performance remains optimal.</p>
<p>Remember that specifying the initial capacity can lead to performance gains, especially when the size of the dataset is known beforehand. This is because it minimizes the number of resizes that need to occur as the collection grows.</p>
<p>While <code>Dictionary&#x3C;TKey, TValue></code>, <code>HashSet&#x3C;T></code>, and <code>OrderedDictionary</code> use prime numbers to determine their capacities, other collections like <code>Stack&#x3C;T></code>, <code>Queue&#x3C;T></code>, <code>SortedList&#x3C;TKey, TValue></code>, and <code>List&#x3C;T></code> follow a simpler doubling strategy. This knowledge allows you to predict and control the memory usage and performance characteristics of your collections more accurately.</p>
<p>Happy coding!</p>
</div></article></div><footer class="flex flex-col bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><div class="mt-10"><ul class="flex flex-row justify-between max-w-sm mx-auto pl-4 pr-4"><li class="hover:text-gray-600 dark:hover:text-gray-100"><a href="https://twitter.com/KrishnaAnaril">Twitter</a></li><li><a href="https://krishnamohan.dev/sitemap.xml">Sitemap</a></li><li><a href="https://krishnamohan.dev/rss.xml">RSS</a></li><li><a href="mailto:krishnamohan.a.m@gmail.com">Contact</a></li></ul></div><div class="mx-auto p-5 text-sm"><p>Â© 2021-present <a class="font-bold" href="https://krishnamohan.dev/">Krishna Mohan A M</a>. All Rights Reserved.</p></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"dotnet-collecton","meta":{"title":"Understanding the nuances of C# Collections","description":"This article is based on .NET 9 and C# 13. I aim to cover the behaviors of common collections within the `System.Collections.Generic` namespace.","published":true,"publishedAt":"2025-01-05T00:00:00.000Z","updatedAt":"2025-01-05T00:00:00.000Z","category":"tech","image":"banners/76","keywords":["dotnet","performance"],"authors":["Krishna Mohan A M"]},"content":"\u003cp\u003eThis article is based on .NET 9 and C# 13. I aim to cover the behaviors of common collections within the \u003ccode\u003eSystem.Collections.Generic\u003c/code\u003e namespace.\u003c/p\u003e\n\u003ch2\u003eInsertion behaviors in Dictionary\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eDictionary\u0026#x3C;TKey, TValue\u003e\u003c/code\u003e provides a mapping from a set of keys to a set of values. Values can be inserted into a dictionary with varying behaviors. Insertion in a \u003ccode\u003eDictionary\u003c/code\u003e is implemented by the private method \u003ca href=\"https://github.com/dotnet/runtime/blob/1d1bf92fcf43aa6981804dc53c5174445069c9e4/src/libraries/System.Private.CoreLib/src/System/Collections/Generic/Dictionary.cs#L507\"\u003e\u003ccode\u003eTryInsert\u003c/code\u003e\u003c/a\u003e. This method accepts an additional parameter \u003ccode\u003ebehavior\u003c/code\u003e, which is an enum with values \u003ccode\u003eIgnoreInsertion\u003c/code\u003e, \u003ccode\u003eOverwriteExisting\u003c/code\u003e, and \u003ccode\u003eThrowOnExisting\u003c/code\u003e. Consider the following code, where each operation behaves differently:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-csharp\"\u003e\u003ccode class=\"language-csharp\"\u003e\u003cspan class=\"token class-name\"\u003eDictionary\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e dict \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token constructor-invocation class-name\"\u003eDictionary\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\ndict\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// Calls underlying private method TryInsert with behavior OverwriteExisting\u003c/span\u003e\nDebug\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eAssert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edict\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\ndict\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eTryAdd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// Calls underlying private method TryInsert with behavior IgnoreInsertion\u003c/span\u003e\nDebug\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eAssert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edict\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\ndict\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eAdd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e// Calls underlying private method TryInsert with behavior ThrowOnExisting\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eThe Curious case of 'Capacity' and 'Count'\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003eDictionary\u003c/code\u003e also exposes two properties: \u003ccode\u003eCount\u003c/code\u003e and \u003ccode\u003eCapacity\u003c/code\u003e. \u003ccode\u003eCount\u003c/code\u003e denotes the number of key-value pairs in the dictionary, and \u003ccode\u003eCapacity\u003c/code\u003e denotes the size of the underlying container that holds the dictionary. The \u003ccode\u003eCapacity\u003c/code\u003e property was only exposed from .NET 9 and is not available in older versions of .NET. We can specify the value for \u003ccode\u003eCapacity\u003c/code\u003e in the constructor: \u003ccode\u003eDictionary\u0026#x3C;int, int\u003e dict = new Dictionary\u0026#x3C;int, int\u003e(5);\u003c/code\u003e, which will create an underlying container of size 7. \u003cstrong\u003eWhy size 7?\u003c/strong\u003e Initially, I was puzzled too, so I checked the source code of the Dictionary implementation.\u003c/p\u003e\n\u003cp\u003eThe size is 7 because .NET uses a \u003ca href=\"https://github.com/dotnet/runtime/blob/main/src/libraries/System.Private.CoreLib/src/System/Collections/HashHelpers.cs#L31\"\u003eprime array\u003c/a\u003e, and the code selects the smallest prime number from the array that is larger than the given capacity. Here is the prime array for reference:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-C\"\u003e\u003ccode class=\"language-C\"\u003einternal static ReadOnlySpan\u0026#x26;lt;int\u0026#x26;gt; Primes =\u0026#x26;gt;\r\n    [\r\n        3, 7, 11, 17, 23, 29, 37, 47, 59, 71, 89, 107, 131, 163, 197, 239, 293, 353, 431, 521, 631, 761, 919,\r\n        1103, 1327, 1597, 1931, 2333, 2801, 3371, 4049, 4861, 5839, 7013, 8419, 10103, 12143, 14591,\r\n        17519, 21023, 25229, 30293, 36353, 43627, 52361, 62851, 75431, 90523, 108631, 130363, 156437,\r\n        187751, 225307, 270371, 324449, 389357, 467237, 560689, 672827, 807403, 968897, 1162687, 1395263,\r\n        1674319, 2009191, 2411033, 2893249, 3471899, 4166287, 4999559, 5999471, 7199369\r\n    ];\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow, with the size being 7, when we insert the 8th item into the \u003ccode\u003eDictionary\u003c/code\u003e, .NET needs to resize the underlying container. For resizing, .NET first computes twice the current count and then finds the first prime number from the array that is larger than this value. In this example, it is 7 * 2 = 14, and the next prime in the list is 17. Therefore, after inserting the 8th item, the capacity of the dictionary will be 17.\u003c/p\u003e\n\u003cp\u003eAlso, if you know the size of the data in advance, specifying the capacity can provide a minor performance boost. Please see the benchmark results below for \u003ccode\u003eDictionary\u003c/code\u003e insertion.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/Benchmark.PNG\" alt=\"\"\u003e\u003cem\u003eGist: Benchmark results for Dictionary insert\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eHashSet\u003c/code\u003e and \u003ccode\u003eOrderedDictionary\u003c/code\u003e also behave in the same way with respect to capacity and resizing.\u003c/p\u003e\n\u003cp\u003eFor \u003ccode\u003eStack\u0026#x3C;T\u003e\u003c/code\u003e,\u003ccode\u003e Queue\u0026#x3C;T\u003e\u003c/code\u003e, \u003ccode\u003eSortedList\u0026#x3C;TKey, TValue\u003e\u003c/code\u003e, and \u003ccode\u003eList\u0026#x3C;T\u003e\u003c/code\u003e, resizing is not based on the prime array. In these cases, the container is created with the given capacity in the constructor, and for resizing, the size is simply doubled. Consider the example: \u003ccode\u003eStack\u0026#x3C;int\u003e ints = new Stack\u0026#x3C;int\u003e(5);\u003c/code\u003e. After pushing the 6th item, the size is doubled to 10.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ePriorityQueue\u0026#x3C;TElement, TPriority\u003e\u003c/code\u003e works similarly to \u003ccode\u003eQueue\u0026#x3C;T\u003e\u003c/code\u003e and \u003ccode\u003eList\u0026#x3C;T\u003e\u003c/code\u003e, but the property Capacity is not yet exposed.\u003c/p\u003e\n\u003ch2\u003eFinal Note\u003c/h2\u003e\n\u003cp\u003eUnderstanding the inner workings of collections in C# can greatly enhance your ability to write efficient and effective code. As we've seen, the \u003ccode\u003eDictionary\u0026#x3C;TKey, TValue\u003e\u003c/code\u003e class in .NET 9 has some interesting behaviors, particularly with how it handles capacity and resizing. By leveraging the prime number array for sizing, .NET ensures that the hash table's performance remains optimal.\u003c/p\u003e\n\u003cp\u003eRemember that specifying the initial capacity can lead to performance gains, especially when the size of the dataset is known beforehand. This is because it minimizes the number of resizes that need to occur as the collection grows.\u003c/p\u003e\n\u003cp\u003eWhile \u003ccode\u003eDictionary\u0026#x3C;TKey, TValue\u003e\u003c/code\u003e, \u003ccode\u003eHashSet\u0026#x3C;T\u003e\u003c/code\u003e, and \u003ccode\u003eOrderedDictionary\u003c/code\u003e use prime numbers to determine their capacities, other collections like \u003ccode\u003eStack\u0026#x3C;T\u003e\u003c/code\u003e, \u003ccode\u003eQueue\u0026#x3C;T\u003e\u003c/code\u003e, \u003ccode\u003eSortedList\u0026#x3C;TKey, TValue\u003e\u003c/code\u003e, and \u003ccode\u003eList\u0026#x3C;T\u003e\u003c/code\u003e follow a simpler doubling strategy. This knowledge allows you to predict and control the memory usage and performance characteristics of your collections more accurately.\u003c/p\u003e\n\u003cp\u003eHappy coding!\u003c/p\u003e\n"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"dotnet-collecton"},"buildId":"lt5HvSSstjkta2Ri8qfBw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>