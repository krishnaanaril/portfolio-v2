<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width, shrink-to-fit=no, user-scalable=1, viewport-fit=cover"/><title>Run Stable Diffusion in Azure | Krishna Mohan A M</title><meta name="title" content="Run Stable Diffusion in Azure"/><meta name="description" content="Hardware requirement are pretty challenging for most of the machine learning needs, stable diffusion is no different. I&#x27;ve an Azure subscription can I make use of that?"/><meta name="og:type" content="article"/><meta name="og:url" content="/blog/sd-azure"/><meta name="og:title" content="Run Stable Diffusion in Azure"/><meta name="og:description" content="Hardware requirement are pretty challenging for most of the machine learning needs, stable diffusion is no different. I&#x27;ve an Azure subscription can I make use of that?"/><meta name="og:image" content="https://krishnamohan.dev/banners/69.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:url" content="/blog/sd-azure"/><meta name="twitter:title" content="Run Stable Diffusion in Azure"/><meta name="twitter:description" content="Hardware requirement are pretty challenging for most of the machine learning needs, stable diffusion is no different. I&#x27;ve an Azure subscription can I make use of that?"/><meta name="twitter:image" content="https://krishnamohan.dev/banners/69.png"/><meta name="twitter:site" content="@krishnaanaril"/><meta name="twitter:creator" content="@krishnaanaril"/><meta name="keywords" content="azure, stable-diffusion, machine-learning"/><meta name="og:article:published_time" content="2023-01-16T00:00:00.000Z"/><meta name="og:article:modified_time" content="2023-01-16T00:00:00.000Z"/><meta name="og:article:author" content="Krishna Mohan A M"/><meta name="og:article:section" content="tech"/><meta name="og:article:tag" content="azure, stable-diffusion, machine-learning"/><meta name="next-head-count" content="23"/><link href="https://unpkg.com/prism-themes@1.6.0/themes/prism-shades-of-purple.css" rel="stylesheet"/><link rel="preload" href="/_next/static/css/4c58d0963c75419a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4c58d0963c75419a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-3653f441c4a2aa8a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e1cb0d25eaeaa056.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-911bf6dd096ab7ef.js" defer=""></script><script src="/_next/static/2XCk60k38Uwjqs6389uHr/_buildManifest.js" defer=""></script><script src="/_next/static/2XCk60k38Uwjqs6389uHr/_ssgManifest.js" defer=""></script></head><body class="bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50 px-5 lg:px-0"><div id="__next"><div><nav class="sticky top-0 bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50 bg-opacity-50 dark:bg-opacity-50 backdrop-blur-lg"><section class="hidden lg:flex flex-row justify-center"><nav><ul class="lg:text-xl lg:flex lg:flex-row"><li class=""><a class="block p-4 cursor-pointer" href="/">Home</a></li><li class="border-b-2 border-gray-700 dark:border-gray-300"><a class="block p-4 cursor-pointer" href="/blogs/">Blog</a></li><li class=""><a class="block p-4 cursor-pointer" href="/projects/">Projects</a></li><li class=""><a class="block p-4 cursor-pointer" href="/about/">About</a></li></ul></nav></section><div class="lg:hidden mr-4 py-4 right-0"><button class="p-2" aria-label="view menu items"><svg class="fill-gray-800 dark:fill-gray-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="24px" height="24px"><path d="M0 0h24v24H0z" fill="none"></path><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></nav><div style="display:none" class="fixed top-0 left-0 bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50 bg-opacity-50 dark:bg-opacity-50 backdrop-blur-lg block h-screen lg:hidden p-2 w-screen z-1"><div class="bg-gray-100 bg-opacity-100 m-5 p-5 rounded-lg shadow-xl dark:bg-gray-600 dark:text-gray-50"><div class="flex flex-row justify-end"><button class="dark:text-gray-50" aria-label="close menu items"><svg class="fill-current" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"></path><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button></div><ul class="list-none"><li class=""><a class="block p-4 cursor-pointer" href="/">Home</a></li><li class="border-b-2 border-gray-700 dark:border-gray-300"><a class="block p-4 cursor-pointer" href="/blogs/">Blog</a></li><li class=""><a class="block p-4 cursor-pointer" href="/projects/">Projects</a></li><li class=""><a class="block p-4 cursor-pointer" href="/about/">About</a></li></ul></div></div><div class="min-h-screen"><article class="bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><div><div aria-label="Blog tags/keywords" class="pt-8 flex flex-row justify-center"><a class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full" href="/blogs/tag/azure/">azure</a><a class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full" href="/blogs/tag/stable-diffusion/">stable-diffusion</a><a class="bg-gray-300 dark:bg-gray-700 border border-gray-400 ml-2 mr-2 pb-2 pl-4 pr-4 pt-2 text-sm align-baseline rounded-full" href="/blogs/tag/machine-learning/">machine-learning</a></div><div class="max-w-screen-lg mx-auto"><h1 class="text-5xl font-bold pt-5 pb-5 text-center">Run Stable Diffusion in Azure</h1></div><div class="flex flex-row justify-center m-5 max-w-screen-sm mx-auto"><time class="text-center text-xl">16 January 2023</time></div></div><div class="prose dark:prose-invert lg:prose-xl md:prose-lg max-w-screen-md mx-auto"><p>Hardware requirement are pretty challenging for most of the machine learning needs, stable diffusion is no different. Most of the SaaS offerings' pricing (Dreamstudio, Midjourney) depends on the number of images generated. My intention was totally different than just generating cool images, I want to play around with it and learn how it works.</p>
<p>But wait, I've an Azure subscription. Can I make use of that? I googled around and found a <a href="https://vladiliescu.net/stable-diffusion-web-ui-on-azure-ml/">very informative blog</a> to spin-off an Azure ML instance to run SD. I followed most of that blog with some tweaks for my needs. If you prefer to follow the original reference please do so.</p>
<h2>Prerequisites</h2>
<ul>
<li>Install <a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a> and its <a href="https://learn.microsoft.com/en-us/azure/machine-learning/how-to-configure-cli?tabs=public">ML extension</a></li>
<li>Login to Azure from CLI and set the default subscription.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Log in with your Azure account. This will open webpage, login with your credentials.</span>
az login

<span class="token comment"># List your available subscriptions. Check IsDefault flag to know which one is default</span>
az account list <span class="token operator">--</span>output table

<span class="token comment"># Set your default subscription. </span>
az account <span class="token function">set</span> <span class="token operator">--</span>subscription <span class="token string">"&#x3C;your-subscription-id>"</span>
</code></pre></div>
</li>
<li>Get a <a href="https://huggingface.co/docs/hub/security-tokens#how-to-use-user-access-tokens">Hugging Face User Access Token</a>. This is required to download models.</li>
</ul>
<h2>Setup Azure ML instance</h2>
<ul>
<li>Create a resource group. I chose <code>eastus</code> due to its low cost compared to other regions.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell">az <span class="token function">group</span> create <span class="token operator">--</span>name <span class="token string">"rg-stable-diffusion"</span> <span class="token operator">--</span>location <span class="token string">"eastus"</span>
</code></pre></div>
</li>
<li>Create an ML workspace - youâ€™ll need this to do anything ML-related in Azure.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell">az ml workspace create <span class="token operator">-</span>n <span class="token string">"ml-stable-diffusion"</span> <span class="token operator">-</span>g <span class="token string">"rg-stable-diffusion"</span>
</code></pre></div>
</li>
<li>This step is mildly complex and varies depends on your subscription. I had a Visual Studio Subscription and some of the higher compute instances are forbidden in that.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Command to list compute instances with GPU</span>
az ml compute list-sizes <span class="token operator">-</span>l eastus <span class="token operator">-</span>w <span class="token string">"ml-stable-diffusion"</span> <span class="token operator">-</span>g <span class="token string">"rg-stable-diffusion"</span> <span class="token operator">--</span>output table <span class="token operator">--</span>query <span class="token string">"[?gpus > ``0``, v_cp_us > ``0``].{Name:name, Gpus:gpus, vCPU:v_cp_us}"</span>
</code></pre></div>
<ul>
<li>Open an new <code>YAML</code> file, say <code>compute.yaml</code>, with the details below. I tried with <code>Standard_NC6s_v3</code> firt, but due to my subscriptions limit, I had to switch to <code>Standard_NV6</code>. Refer the <a href="https://azure.microsoft.com/en-us/pricing/details/machine-learning/#NV-series">pricing details</a> for better understanding.
<div class="remark-highlight"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">$schema</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//azuremlschemas.azureedge.net/latest/computeInstance.schema.json 

<span class="token comment"># this name is globally unique, please choose a different name</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> ksd<span class="token punctuation">-</span>tin<span class="token punctuation">-</span>tin
<span class="token key atrule">type</span><span class="token punctuation">:</span> computeinstance

<span class="token comment">#</span>
<span class="token key atrule">size</span><span class="token punctuation">:</span> Standard_NV6
<span class="token key atrule">idle_time_before_shutdown_minutes</span><span class="token punctuation">:</span> <span class="token number">15</span>
</code></pre></div>
</li>
<li>Run the CLI command to create instance. This will take couple of minutes. Once done you can check the status in <a href="https://ml.azure.com/">Azure ML Studio</a> or in CLI.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell">az ml compute create <span class="token operator">-</span>f compute<span class="token punctuation">.</span>yml <span class="token operator">-</span>w <span class="token string">"ml-stable-diffusion"</span> <span class="token operator">-</span>g <span class="token string">"rg-stable-diffusion"</span>
</code></pre></div>
</li>
</ul>
</li>
</ul>
<h2>Setup Stable Diffusion Web UI</h2>
<p>Multiple WebUIs are available like <a href="https://github.com/Sygil-Dev/sygil-webui">sygil-webui</a>, <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui">stable-diffusion-webui</a> and <a href="https://github.com/invoke-ai/InvokeAI">InvokeAI</a>. Here we'll be using <code>stable-diffusion-webui</code>.</p>
<ul>
<li>Make sure your compute instance is running, then click its <code>Terminal</code> link to start a new terminal session.</li>
<li>Clone the <code>AUTOMATIC1111/stable-diffusion-webui</code> repo.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Clone the SD WebUI</span>
git clone https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/AUTOMATIC1111/stable-diffusion-webui<span class="token punctuation">.</span>git

<span class="token comment"># Go to the models folder</span>
cd stable-diffusion-webui/models/Stable-diffusion/
</code></pre></div>
</li>
<li>Download SD2.1 model from Hugging Face.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Download the x768 model, specifically the safetensors versions for increased security and loading speed</span>
curl <span class="token operator">-</span>H <span class="token string">"Authorization: Bearer &#x3C;your-huggingface-token>"</span> https:<span class="token operator">/</span><span class="token operator">/</span>huggingface<span class="token punctuation">.</span>co/stabilityai/stable-diffusion-2-1/resolve/main/v2-1_768-ema-pruned<span class="token punctuation">.</span>safetensors <span class="token operator">--</span>location <span class="token operator">--</span>output v2-1_768-ema-pruned<span class="token punctuation">.</span>safetensors

<span class="token comment"># and its config as well</span>
curl https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com/Stability-AI/stablediffusion/main/configs/stable-diffusion/v2-inference-v<span class="token punctuation">.</span>yaml <span class="token operator">--</span>output v2-1_768-ema-pruned<span class="token punctuation">.</span>yaml
</code></pre></div>
</li>
<li>Install web ui's dependencies. This will take few minutes to complete.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Create a new Conda env with the desired Python version</span>
conda create <span class="token operator">-</span>n a1111-sdwebui python=3<span class="token punctuation">.</span>10 <span class="token operator">-</span>y

<span class="token comment"># Activate the new env</span>
conda activate a1111-sdwebui

<span class="token comment"># Go back to the root of the repo..</span>
cd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># ..so we can install the repository's dependencies..</span>
pip install <span class="token operator">-</span>r requirements_versions<span class="token punctuation">.</span>txt 

<span class="token comment"># ..which for some reason won't install everything leading to the web ui crashing </span>
<span class="token comment"># while complaining about `undefined symbol: cublasLtGetStatusString, version libcublasLt.so.11`</span>
<span class="token comment"># So, we need to install the missing dependencies directly from conda</span>
conda install pytorch=1<span class="token punctuation">.</span>13 torchvision=0<span class="token punctuation">.</span>14 torchaudio=0<span class="token punctuation">.</span>13 pytorch-cuda=11<span class="token punctuation">.</span>7 <span class="token operator">-</span>c pytorch <span class="token operator">-</span>c nvidia <span class="token operator">-</span>y


<span class="token comment"># If you want/need an older version, see the alternatives here https://pytorch.org/get-started/previous-versions/</span>
<span class="token comment"># e.g. I've had success with </span>
<span class="token comment"># conda install pytorch==1.12.1 torchvision==0.13.1 torchaudio==0.12.1 cudatoolkit=11.3 -c pytorch -y</span>

<span class="token comment"># Mark everything as a safe directory,</span>
<span class="token comment"># we need this because when first run,</span>
<span class="token comment"># the web ui will try to clone some repos under this directory, </span>
<span class="token comment"># and we'll get a lot of dubious ownership errors,</span>
<span class="token comment"># which we don't really want to be honest</span>
git config <span class="token operator">--</span>global <span class="token operator">--</span>add safe<span class="token punctuation">.</span>directory <span class="token string">'*'</span>
</code></pre></div>
</li>
<li>Launch the web UI. This will also take couple of minutes as it requires some extra dependencies to start. If you don't provide username/password, someone will <a href="https://www.reddit.com/r/StableDiffusion/comments/y52yt0/why_are_there_images_i_never_generated_in_my/">use your sytem</a> via open gradio share.
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell">accelerate launch <span class="token operator">--</span>mixed_precision=fp16 <span class="token operator">--</span>num_cpu_threads_per_process=6 launch<span class="token punctuation">.</span>py <span class="token operator">--</span>precision full <span class="token operator">--</span>no-half <span class="token operator">--</span>share <span class="token operator">--</span>gradio-auth &#x3C;user>:&#x3C;pass>
</code></pre></div>
</li>
</ul>
<h2>Run it again</h2>
<p>Next time you want run SD, just run the follwoing commands.</p>
<div class="remark-highlight"><pre class="language-powershell"><code class="language-powershell"><span class="token comment"># Activate the new env</span>
conda activate a1111-sdwebui

<span class="token comment"># Launc</span>
accelerate launch <span class="token operator">--</span>mixed_precision=fp16 <span class="token operator">--</span>num_cpu_threads_per_process=6 launch<span class="token punctuation">.</span>py <span class="token operator">--</span>precision full <span class="token operator">--</span>no-half <span class="token operator">--</span>share <span class="token operator">--</span>gradio-auth &#x3C;user>:&#x3C;pass>
</code></pre></div>
<h2>Wrap Up</h2>
<p>We can do a lot of improvements on top of it, like running image generation <a href="https://github.com/facebookresearch/xformers">faster</a> or installing extensions. It's up to you to further explore the same.</p>
</div></article></div><footer class="flex flex-col bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-50"><div class="mt-10"><ul class="flex flex-row justify-between max-w-sm mx-auto pl-4 pr-4"><li class="hover:text-gray-600 dark:hover:text-gray-100"><a href="https://twitter.com/KrishnaAnaril">Twitter</a></li><li><a href="https://krishnamohan.dev/sitemap.xml">Sitemap</a></li><li><a href="https://krishnamohan.dev/rss.xml">RSS</a></li><li><a href="mailto:krishnamohan.a.m@gmail.com">Contact</a></li></ul></div><div class="mx-auto p-5 text-sm"><p>Â© 2021-present <a class="font-bold" href="https://krishnamohan.dev/">Krishna Mohan A M</a>. All Rights Reserved.</p></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"sd-azure","meta":{"title":"Run Stable Diffusion in Azure","description":"Hardware requirement are pretty challenging for most of the machine learning needs, stable diffusion is no different. I've an Azure subscription can I make use of that?","published":true,"publishedAt":"2023-01-16T00:00:00.000Z","updatedAt":"2023-01-16T00:00:00.000Z","category":"tech","image":"banners/69","keywords":["azure","stable-diffusion","machine-learning"],"authors":["Krishna Mohan A M"]},"content":"\u003cp\u003eHardware requirement are pretty challenging for most of the machine learning needs, stable diffusion is no different. Most of the SaaS offerings' pricing (Dreamstudio, Midjourney) depends on the number of images generated. My intention was totally different than just generating cool images, I want to play around with it and learn how it works.\u003c/p\u003e\n\u003cp\u003eBut wait, I've an Azure subscription. Can I make use of that? I googled around and found a \u003ca href=\"https://vladiliescu.net/stable-diffusion-web-ui-on-azure-ml/\"\u003every informative blog\u003c/a\u003e to spin-off an Azure ML instance to run SD. I followed most of that blog with some tweaks for my needs. If you prefer to follow the original reference please do so.\u003c/p\u003e\n\u003ch2\u003ePrerequisites\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eInstall \u003ca href=\"https://learn.microsoft.com/en-us/cli/azure/install-azure-cli\"\u003eAzure CLI\u003c/a\u003e and its \u003ca href=\"https://learn.microsoft.com/en-us/azure/machine-learning/how-to-configure-cli?tabs=public\"\u003eML extension\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eLogin to Azure from CLI and set the default subscription.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# Log in with your Azure account. This will open webpage, login with your credentials.\u003c/span\u003e\naz login\n\n\u003cspan class=\"token comment\"\u003e# List your available subscriptions. Check IsDefault flag to know which one is default\u003c/span\u003e\naz account list \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eoutput table\n\n\u003cspan class=\"token comment\"\u003e# Set your default subscription. \u003c/span\u003e\naz account \u003cspan class=\"token function\"\u003eset\u003c/span\u003e \u003cspan class=\"token operator\"\u003e--\u003c/span\u003esubscription \u003cspan class=\"token string\"\u003e\"\u0026#x3C;your-subscription-id\u003e\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eGet a \u003ca href=\"https://huggingface.co/docs/hub/security-tokens#how-to-use-user-access-tokens\"\u003eHugging Face User Access Token\u003c/a\u003e. This is required to download models.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eSetup Azure ML instance\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eCreate a resource group. I chose \u003ccode\u003eeastus\u003c/code\u003e due to its low cost compared to other regions.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003eaz \u003cspan class=\"token function\"\u003egroup\u003c/span\u003e create \u003cspan class=\"token operator\"\u003e--\u003c/span\u003ename \u003cspan class=\"token string\"\u003e\"rg-stable-diffusion\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e--\u003c/span\u003elocation \u003cspan class=\"token string\"\u003e\"eastus\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eCreate an ML workspace - youâ€™ll need this to do anything ML-related in Azure.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003eaz ml workspace create \u003cspan class=\"token operator\"\u003e-\u003c/span\u003en \u003cspan class=\"token string\"\u003e\"ml-stable-diffusion\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eg \u003cspan class=\"token string\"\u003e\"rg-stable-diffusion\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eThis step is mildly complex and varies depends on your subscription. I had a Visual Studio Subscription and some of the higher compute instances are forbidden in that.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# Command to list compute instances with GPU\u003c/span\u003e\naz ml compute list-sizes \u003cspan class=\"token operator\"\u003e-\u003c/span\u003el eastus \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ew \u003cspan class=\"token string\"\u003e\"ml-stable-diffusion\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eg \u003cspan class=\"token string\"\u003e\"rg-stable-diffusion\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eoutput table \u003cspan class=\"token operator\"\u003e--\u003c/span\u003equery \u003cspan class=\"token string\"\u003e\"[?gpus \u003e ``0``, v_cp_us \u003e ``0``].{Name:name, Gpus:gpus, vCPU:v_cp_us}\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eOpen an new \u003ccode\u003eYAML\u003c/code\u003e file, say \u003ccode\u003ecompute.yaml\u003c/code\u003e, with the details below. I tried with \u003ccode\u003eStandard_NC6s_v3\u003c/code\u003e firt, but due to my subscriptions limit, I had to switch to \u003ccode\u003eStandard_NV6\u003c/code\u003e. Refer the \u003ca href=\"https://azure.microsoft.com/en-us/pricing/details/machine-learning/#NV-series\"\u003epricing details\u003c/a\u003e for better understanding.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-yaml\"\u003e\u003ccode class=\"language-yaml\"\u003e\u003cspan class=\"token key atrule\"\u003e$schema\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e https\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e//azuremlschemas.azureedge.net/latest/computeInstance.schema.json \n\n\u003cspan class=\"token comment\"\u003e# this name is globally unique, please choose a different name\u003c/span\u003e\n\u003cspan class=\"token key atrule\"\u003ename\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e ksd\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003etin\u003cspan class=\"token punctuation\"\u003e-\u003c/span\u003etin\n\u003cspan class=\"token key atrule\"\u003etype\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e computeinstance\n\n\u003cspan class=\"token comment\"\u003e#\u003c/span\u003e\n\u003cspan class=\"token key atrule\"\u003esize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e Standard_NV6\n\u003cspan class=\"token key atrule\"\u003eidle_time_before_shutdown_minutes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eRun the CLI command to create instance. This will take couple of minutes. Once done you can check the status in \u003ca href=\"https://ml.azure.com/\"\u003eAzure ML Studio\u003c/a\u003e or in CLI.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003eaz ml compute create \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef compute\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyml \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ew \u003cspan class=\"token string\"\u003e\"ml-stable-diffusion\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eg \u003cspan class=\"token string\"\u003e\"rg-stable-diffusion\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eSetup Stable Diffusion Web UI\u003c/h2\u003e\n\u003cp\u003eMultiple WebUIs are available like \u003ca href=\"https://github.com/Sygil-Dev/sygil-webui\"\u003esygil-webui\u003c/a\u003e, \u003ca href=\"https://github.com/AUTOMATIC1111/stable-diffusion-webui\"\u003estable-diffusion-webui\u003c/a\u003e and \u003ca href=\"https://github.com/invoke-ai/InvokeAI\"\u003eInvokeAI\u003c/a\u003e. Here we'll be using \u003ccode\u003estable-diffusion-webui\u003c/code\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMake sure your compute instance is running, then click its \u003ccode\u003eTerminal\u003c/code\u003e link to start a new terminal session.\u003c/li\u003e\n\u003cli\u003eClone the \u003ccode\u003eAUTOMATIC1111/stable-diffusion-webui\u003c/code\u003e repo.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# Clone the SD WebUI\u003c/span\u003e\ngit clone https:\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003egithub\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecom/AUTOMATIC1111/stable-diffusion-webui\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egit\n\n\u003cspan class=\"token comment\"\u003e# Go to the models folder\u003c/span\u003e\ncd stable-diffusion-webui/models/Stable-diffusion/\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eDownload SD2.1 model from Hugging Face.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# Download the x768 model, specifically the safetensors versions for increased security and loading speed\u003c/span\u003e\ncurl \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eH \u003cspan class=\"token string\"\u003e\"Authorization: Bearer \u0026#x3C;your-huggingface-token\u003e\"\u003c/span\u003e https:\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003ehuggingface\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eco/stabilityai/stable-diffusion-2-1/resolve/main/v2-1_768-ema-pruned\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esafetensors \u003cspan class=\"token operator\"\u003e--\u003c/span\u003elocation \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eoutput v2-1_768-ema-pruned\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esafetensors\n\n\u003cspan class=\"token comment\"\u003e# and its config as well\u003c/span\u003e\ncurl https:\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003eraw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egithubusercontent\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecom/Stability-AI/stablediffusion/main/configs/stable-diffusion/v2-inference-v\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eoutput v2-1_768-ema-pruned\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eyaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eInstall web ui's dependencies. This will take few minutes to complete.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# Create a new Conda env with the desired Python version\u003c/span\u003e\nconda create \u003cspan class=\"token operator\"\u003e-\u003c/span\u003en a1111-sdwebui python=3\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e10 \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ey\n\n\u003cspan class=\"token comment\"\u003e# Activate the new env\u003c/span\u003e\nconda activate a1111-sdwebui\n\n\u003cspan class=\"token comment\"\u003e# Go back to the root of the repo..\u003c/span\u003e\ncd \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# ..so we can install the repository's dependencies..\u003c/span\u003e\npip install \u003cspan class=\"token operator\"\u003e-\u003c/span\u003er requirements_versions\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etxt \n\n\u003cspan class=\"token comment\"\u003e# ..which for some reason won't install everything leading to the web ui crashing \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# while complaining about `undefined symbol: cublasLtGetStatusString, version libcublasLt.so.11`\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# So, we need to install the missing dependencies directly from conda\u003c/span\u003e\nconda install pytorch=1\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e13 torchvision=0\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e14 torchaudio=0\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e13 pytorch-cuda=11\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e7 \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ec pytorch \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ec nvidia \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ey\n\n\n\u003cspan class=\"token comment\"\u003e# If you want/need an older version, see the alternatives here https://pytorch.org/get-started/previous-versions/\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# e.g. I've had success with \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# conda install pytorch==1.12.1 torchvision==0.13.1 torchaudio==0.12.1 cudatoolkit=11.3 -c pytorch -y\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Mark everything as a safe directory,\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# we need this because when first run,\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# the web ui will try to clone some repos under this directory, \u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# and we'll get a lot of dubious ownership errors,\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# which we don't really want to be honest\u003c/span\u003e\ngit config \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eglobal \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eadd safe\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edirectory \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003cli\u003eLaunch the web UI. This will also take couple of minutes as it requires some extra dependencies to start. If you don't provide username/password, someone will \u003ca href=\"https://www.reddit.com/r/StableDiffusion/comments/y52yt0/why_are_there_images_i_never_generated_in_my/\"\u003euse your sytem\u003c/a\u003e via open gradio share.\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003eaccelerate launch \u003cspan class=\"token operator\"\u003e--\u003c/span\u003emixed_precision=fp16 \u003cspan class=\"token operator\"\u003e--\u003c/span\u003enum_cpu_threads_per_process=6 launch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eprecision full \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eno-half \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eshare \u003cspan class=\"token operator\"\u003e--\u003c/span\u003egradio-auth \u0026#x3C;user\u003e:\u0026#x3C;pass\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eRun it again\u003c/h2\u003e\n\u003cp\u003eNext time you want run SD, just run the follwoing commands.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# Activate the new env\u003c/span\u003e\nconda activate a1111-sdwebui\n\n\u003cspan class=\"token comment\"\u003e# Launc\u003c/span\u003e\naccelerate launch \u003cspan class=\"token operator\"\u003e--\u003c/span\u003emixed_precision=fp16 \u003cspan class=\"token operator\"\u003e--\u003c/span\u003enum_cpu_threads_per_process=6 launch\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epy \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eprecision full \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eno-half \u003cspan class=\"token operator\"\u003e--\u003c/span\u003eshare \u003cspan class=\"token operator\"\u003e--\u003c/span\u003egradio-auth \u0026#x3C;user\u003e:\u0026#x3C;pass\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eWrap Up\u003c/h2\u003e\n\u003cp\u003eWe can do a lot of improvements on top of it, like running image generation \u003ca href=\"https://github.com/facebookresearch/xformers\"\u003efaster\u003c/a\u003e or installing extensions. It's up to you to further explore the same.\u003c/p\u003e\n"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"sd-azure"},"buildId":"2XCk60k38Uwjqs6389uHr","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>