{"pageProps":{"id":"using-casbin-for-authorization-in-dotnet","meta":{"title":"Using Casbin for authorization in dotnet","description":"Casbin is a powerful and efficient open-source access control library. It provides support for enforcing authorization based on various access control models. Here I'll be sharing my thoughts on Casbin.NET, an authorization library for dotnet.","published":true,"publishedAt":"2021-02-14T00:00:00.000Z","updatedAt":"2021-05-14T00:00:00.000Z","category":"tech","image":"banners/07","keywords":["casbin","abac","auth","dotnet"],"authors":["Krishna Mohan A M"]},"content":"<p>Our organization, as part of common platform initiative, was trying to create an authorization mechanism for multiple applications in our ecosystem. Last week as a part of this initiative I was browsing internet to find a client library that makes use of Attribute based access control (ABAC). <a href=\"https://github.com/topics/abac\">Casbin</a> is one of the most starred libraries in the topic ABAC.\r\nSo I thought of giving it a try.</p>\n<p>The primary language for Casbin was Go, since it was developed in Go itself. But that wasn't a problem as they've already created similar libraries in java, dotnet and nodejs. I picked <a href=\"https://github.com/casbin/Casbin.NET\">Casbin.Net</a> due to my proficiency in C#. For the sake of simplicity I'm only evaluating Casbin's ABAC feature here. For full feature list please see the <a href=\"https://casbin.org/docs/en/supported-models\">official documentation</a>.</p>\n<h2>PERM Modeling Language</h2>\n<p>Casbin introduces a new policy language named PERM (Policy, Effect, Request and Matcher) modeling language. If interested you can learn more about it in the author's <a href=\"https://arxiv.org/abs/1903.09756\">research paper</a>.</p>\n<p><img src=\"assets/images/PERM_MetaModel.svg\" alt=\"PERM Meta Model\">\r\n<em>PERM Meta Model</em></p>\n<h3>Request</h3>\n<p>Request is defined as key-value pair. The key is always r, while the value is a list of attributes. An access request is usually represented by the classic triple: accessing entity (sub), accessed resource (obj) and the access method (act). In this condition, we have: <code>attributes = sub; obj; act</code>, or in PML's grammar: <code>r = sub, obj, act</code>.</p>\n<h3>Policy</h3>\n<p>Policy is defined as key-value pair. The key is always p, which represents an abstract policy rule entity. The value attributes denotes the attribute names that p has. E.g.: <code>p = sub, obj, act</code>.</p>\n<h3>Policy Rule</h3>\n<p>Policy rule is an instance of the above policy. The number of elements in the tuple will be identical with the attribute names in policy. For example, the above policy rule: <code>alice, data1, read</code> generates a binding to the attributes like: <code>p.sub = alice, p.obj = data1, p.act = read</code>.</p>\n<h3>Matcher</h3>\n<p>Matcher determines how the policy rules are evaluated against the request. The simplest matcher is: <code>m = r.sub == p.sub &#x26;&#x26; r.obj == p.obj &#x26;&#x26; r.act == p.act</code> (m represents the matcher). It means the matcher returns true only if subject, object and action in the access request exactly match the respective fields in a policy rule.</p>\n<h3>Effect</h3>\n<p>The effect primitive determines whether the request should be approved if\r\nmultiple policy rules match the request. In a effect term, the <strong>quantifier</strong> aggregates the multiple decisions from the valid set for condition into a single boolean value. It can be 'some', 'max' or 'min'. condition functions in a similar way as matcher, but it is used for filtering valid decisions instead of matching the policy rules with the request. E.g: <code>e = some(where (p.eft == allow))</code></p>\n<h2>Examples</h2>\n<p>First we need to create a Casbin enforcer object which accepts two parameters in its constructor. First parameter is <a href=\"https://casbin.org/docs/en/supported-models\">Model</a> and the second one is <a href=\"https://casbin.org/docs/en/adapters\">Adapter</a>.</p>\n<ul>\n<li>\n<p>Model</p>\n<p>Model is defined in a file with .conf extension. A model <code>CONF</code> should have at least four sections: <code>[request_definition], [policy_definition], [policy_effect], [matchers]</code>. If a model uses RBAC, it should also add the <code>[role_definition]</code> section. A model <code>CONF</code> can contain comments. The comments start with <code>#</code>, and <code>#</code> will comment the rest of the line.\r\nThe matcher evaluation in Casbin is implemented by expression evaluators in each language.</p>\n</li>\n<li>\n<p>Adapter</p>\n<p>In Casbin, the policy storage is implemented as an adapter (aka middleware for Casbin). For full set of supported adapters refer the <a href=\"https://casbin.org/docs/en/adapters#supported-adapters\">documentation</a>. For the examples below I'm using the default file adapter, such that policy rules are defined in csv format.</p>\n</li>\n</ul>\n<p>You can find the full source code in my <a href=\"https://github.com/krishnaanaril/try-outs/tree/master/casbin-poc\">github repository</a>.</p>\n<h3>Basic</h3>\n<p>For the basic example we are just checking whether the subject, object and action attributes of both policy and request match.</p>\n<ul>\n<li>basic_model.conf</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">[request_definition]\r\nr = sub, obj, act\r\n\r\n[policy_definition]\r\np = sub, obj, act\r\n\r\n[policy_effect]\r\ne = some(where (p.eft == allow))\r\n\r\n[matchers]\r\nm = r.sub == p.sub &#x26;amp;&#x26;amp; r.obj == p.obj &#x26;amp;&#x26;amp; r.act == p.act</code></pre></div>\n<ul>\n<li>basic_policy.csv</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">p, alice@example.com, BasicTest, Get</code></pre></div>\n<ul>\n<li>Verification Code</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> e <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Enforcer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./casbin-config/basic_model.conf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./casbin-config/basic_policy.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">Enforce</span><span class=\"token punctuation\">(</span>sub<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">,</span> act<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// permit alice to read data1</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Access Granted\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">else</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// deny the request, show an error</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Access Denied\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>    \n</code></pre></div>\n<h3>Basic with environment attribute</h3>\n<p>Here we are passing an extra attribute to add policies on environment. User have access to only dev environment and all other requests will fail.</p>\n<ul>\n<li>env_model.conf</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">[request_definition]\r\nr = sub, obj, act, env\r\n\r\n[policy_definition]\r\np = sub, obj, act, env\r\n\r\n[policy_effect]\r\ne = some(where (p.eft == allow))\r\n\r\n[matchers]\r\nm = r.sub == p.sub &#x26;amp;&#x26;amp; r.obj == p.obj &#x26;amp;&#x26;amp; r.act == p.act &#x26;amp;&#x26;amp; r.env == p.env</code></pre></div>\n<ul>\n<li>env_policy.csv</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">p, alice@example.com, BasicTest, Get, dev</code></pre></div>\n<ul>\n<li>Verification Code</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> e <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Enforcer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./casbin-config/env_model.conf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./casbin-config/env_policy.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">Enforce</span><span class=\"token punctuation\">(</span>sub<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">,</span> act<span class=\"token punctuation\">,</span> env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// permit alice to read data1</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Access Granted\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">else</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// deny the request, show an error</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Access Denied\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>   \n</code></pre></div>\n<h3>Advanced usage</h3>\n<p>Here please note the matcher statement of the model. A function is invoked from the environment object. Unlike previous examples here the request attribute <code>env</code> is an object with method <code>IsAPAC()</code> which returns true only if the given location is in the list of APAC countries.</p>\n<ul>\n<li>advanced_model.csv</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">[request_definition]\r\nr = sub, obj, act, env\r\n\r\n[policy_definition]\r\np = sub, obj, act\r\n\r\n[policy_effect]\r\ne = some(where (p.eft == allow))\r\n\r\n[matchers]\r\nm = r.sub == p.sub &#x26;amp;&#x26;amp; r.obj == p.obj &#x26;amp;&#x26;amp; r.act == p.act &#x26;amp;&#x26;amp; r.env.IsAPAC()</code></pre></div>\n<ul>\n<li>advanced_policy.csv</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">p, alice@example.com, BasicTest, Get</code></pre></div>\n<ul>\n<li>Verification Code</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Environment</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> _location<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> APAC_COUNTRIES <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"India\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"UAE\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Srilanka\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Environment</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> location<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _location <span class=\"token operator\">=</span> location<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">IsAPAC</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">Exists</span><span class=\"token punctuation\">(</span>APAC_COUNTRIES<span class=\"token punctuation\">,</span> element <span class=\"token operator\">=></span> element <span class=\"token operator\">==</span> _location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/*</span>\n<span class=\"token comment\">* Some lines of code</span>\n<span class=\"token comment\">*/</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> e <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Enforcer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./casbin-config/advanced_model.conf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./casbin-config/advanced_policy.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Environment</span> env <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Environment</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">Enforce</span><span class=\"token punctuation\">(</span>sub<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">,</span> act<span class=\"token punctuation\">,</span> env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// permit alice to read data1</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Access Granted\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">else</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// deny the request, show an error</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Access Denied\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>  \n</code></pre></div>\n<h2>Final Thoughts</h2>\n<p>I'm impressed with the documentation and ease of use of Casbin library. But I'm bit skeptical about its performance in real production environments. To gather some opinions I asked this question in <a href=\"https://news.ycombinator.com/item?id=26112460\">Hacker News</a>, but unfortunately I got reply only from the library's author himself. I had a discussion with our senior architect, who recommended to use the standard <code>XACML</code> for which only some java libraries are available. As a next step, I need to check some libraries based on XACML.</p>\n"},"__N_SSG":true}